function create() 
	shouldPrint = true

	time = 0;

	for x=0,22 do
		for y=0,7 do
			setLed(x, y, (y/7) * 255, 0, 0)
		end
	end

	xx = 4
	yy = 1
	cycle = 0

	backgroundleds = {}
    typeleds = {}
    for x=0,21 do
		backgroundleds[x] = {}
        typeleds[x] = {}
        for y=0,6 do
			local f = (x * math.pi) / 10

			local r = 0
			local g = 0
			local b = 0

		    backgroundleds[x][y] = { r = r, g = g, b = b }
            typeleds[x][y] = { r = r, g = g, b = b }
		end
	end

    balls = {}

    rainbow = require("scripts/modules/rainbow"):new()
    rainbow:create()
end

function update(dt)
	time = time + dt

	--rainbow:update(dt)

	for x=0,21 do
		for y=0,6 do
            typeleds[x][y].r = typeleds[x][y].r + 1 * dt
            typeleds[x][y].g = typeleds[x][y].g + 1 * dt
            typeleds[x][y].b = typeleds[x][y].b + 1 * dt

            if typeleds[x][y].r > 1 then typeleds[x][y].r = 1 end
            if typeleds[x][y].g > 1 then typeleds[x][y].g = 1 end
            if typeleds[x][y].b > 1 then typeleds[x][y].b = 1 end
		end
	end

    --[[for x=0,21 do
		for y=0,6 do
            local r = lerp(backgroundleds[x][y].r, 255, 1 - typeleds[x][y].r)
            local g = lerp(backgroundleds[x][y].g, 255, 1 - typeleds[x][y].g)   
            local b = lerp(backgroundleds[x][y].b, 255, 1 - typeleds[x][y].b)

			setLed(x, y, r, g, b)
		end
	end]]--

    if #balls <= 5 then
        local vx = math.random(-5, 5)
        while vx >= -0.5 and vx <= 0.5 do vx = math.random(-5, 5) end

        table.insert(balls, { x = math.random(0, 21), y = 2,
                              vx = math.random(-5, 5), vy = 0, 
                              r = math.random(127, 255), g = math.random(127, 255), b = math.random(127, 255) })
    end

    for k,v in pairs(balls) do
        v.x = v.x + v.vx * dt
        v.y = v.y + v.vy * dt
        v.vy = v.vy + 9.82 * dt
        
        if v.vy > 10 then
            v.vy = 10
        end

        if v.x <= 1 or v.x >= 21 then
             v.vx = -v.vx
        end

        if v.y >= 7 then
            v.vy = -(v.vy)
        end
        

        drawCircle(v.x, v.y, 0.2, v.r, v.g, v.b)
    end

end

function drawCircle(x, y, radius, r, g, b)
    for i = 1, 360 do
        local angle = i * math.pi / 180
        local ptx, pty = x + radius * math.cos( angle ), y + radius * math.sin( angle )
        ptx = math.floor(ptx + 0.5)
        pty = math.floor(pty + 0.5)

        if ptx >= 0 and pty >= 0 and ptx <= 21 and pty <= 6 then
            setLed(ptx, pty, r, g, b)
        end
    end
end


function keyDown(vkcode, x, y, key)
	local vkhex = string.format("%02x", vkcode)
	vkhex = string.upper(vkhex)

	--print("0x"..vkhex .. " " .. key .. " was pressed. Corresponds to " .. x .. ":" .. y)

    --print(x, y)

	--setLed(x, y, 255, 255, 255)

	--[[if key == "f4" or key == "f5" then
		print("Reloading script and keymap")
		loadKeymap("keymaps/sv_keymap.keyconf")
		loadScript("scripts/test.lua")
	end]]--

    if x >= 0 and x <= 21 and y >= 0 and y <= 6 then
        local r = 1.25
        for i = 1, 360 do
            local angle = i * math.pi / 180
            local ptx, pty = x + r * math.cos( angle ), y + r * math.sin( angle )
            ptx = math.floor(ptx + 0.5)
            pty = math.floor(pty + 0.5)

            if ptx >= 0 and pty >= 0 and ptx <= 21 and pty <= 6 then
                --typeleds[ptx][pty].r = 0
                --typeleds[ptx][pty].g = 0
                --typeleds[ptx][pty].b = 0
            end
        end
    end

    x = math.floor(x + 0.5)
    y = math.floor(y + 0.5)
    if x >= 0 and x <= 22 and y >= 0 and y <= 6 then
        typeleds[x][y].r = 0
        typeleds[x][y].g = 0
        typeleds[x][y].b = 0
    end

    for x=0,21 do
		for y=0,6 do
			setLed(x, y, 255, 255, 255)
		end
	end

end

function keyUp(x, y, key)
    for x=0,21 do
		for y=0,6 do
			setLed(x, y, 255, 255, 255)
		end
	end
end

function lerp(a, b, t)
    return a + t*(b - a)
end
